from flask import Flask, request, jsonify, render_template, render_template, send_file, flash, redirect, make_response
import pandas as pd
import os
from datetime import datetime
from modules.scraper import ETFScraper

test_data = {'ok': True, '日期': ['2023/06/28', '2023/06/29'
                                ], '3231-緯創資通': {'持股數量': ['5192000', '5192000'
                                                          ], '市值': ['408610400', '434051200'
                                                                    ], '佔淨值比例': ['4.973%', '5.201%'
                                                                                 ]
                                                 }, '6121-新普科技': {'持股數量': ['892000', '957000'
                                                                           ], '市值': ['295698000', '316288500'
                                                                                     ], '佔淨值比例': ['3.599%', '3.790%'
                                                                                                  ]
                                                                  }, '2454-聯發科技': {'持股數量': ['425000', '425000'
                                                                                            ], '市值': ['295375000', '295800000'
                                                                                                      ], '佔淨值比例': ['3.595%', '3.544%'
                                                                                                                   ]
                                                                                   }, '8112-至上電子': {'持股數量': ['5398000', '5398000'
                                                                                                             ], '市值': ['263422400', '263152500'
                                                                                                                       ], '佔淨值比例': ['3.206%', '3.153%'
                                                                                                                                    ]
                                                                                                    }, '2357-華碩電腦': {'持股數量': ['791000', '791000'
                                                                                                                              ], '市值': ['249956000', '248374000'
                                                                                                                                        ], '佔淨值比例': ['3.042%', '2.976%'
                                                                                                                                                     ]
                                                                                                                     }, '3711-日月光投': {'持股數量': ['2008000', '2008000'
                                                                                                                                               ], '市值': ['248992000', '245980000'
                                                                                                                                                         ], '佔淨值比例': ['3.030%', '2.947%'
                                                                                                                                                                      ]
                                                                                                                                      }, '6176-瑞儀光電': {'持股數量': ['2139000', '2139000'
                                                                                                                                                                ], '市值': ['237429000', '237429000'
                                                                                                                                                                          ], '佔淨值比例': ['2.889%', '2.845%'
                                                                                                                                                                                       ]
                                                                                                                                                       }, '2353-宏碁股份': {'持股數量': ['6772000', '6772000'
                                                                                                                                                                                 ], '市值': ['227200600', '217042600'
                                                                                                                                                                                           ], '佔淨值比例': ['2.765%', '2.601%'
                                                                                                                                                                                                        ]
                                                                                                                                                                        }, '2449-京元電子': {'持股數量': ['3949000', '3949000'
                                                                                                                                                                                                  ], '市值': ['225487900', '222723600'
                                                                                                                                                                                                            ], '佔淨值比例': ['2.744%', '2.669%'
                                                                                                                                                                                                                         ]
                                                                                                                                                                                         }, '8016-矽創電子': {'持股數量': ['922000', '922000'
                                                                                                                                                                                                                   ], '市值': ['219436000', '220358000'
                                                                                                                                                                                                                             ], '佔淨值比例': ['2.670%', '2.640%'
                                                                                                                                                                                                                                          ]
                                                                                                                                                                                                          }, '4915-致伸科技': {'持股數量': ['3217000', '3443000'
                                                                                                                                                                                                                                    ], '市值': ['210713500', '226549400'
                                                                                                                                                                                                                                              ], '佔淨值比例': ['2.564%', '2.715%'
                                                                                                                                                                                                                                                           ]
                                                                                                                                                                                                                           }, '2303-聯華電子': {'持股數量': ['4287000', '4287000'
                                                                                                                                                                                                                                                     ], '市值': ['210491700', '207919500'
                                                                                                                                                                                                                                                               ], '佔淨值比例': ['2.562%', '2.491%'
                                                                                                                                                                                                                                                                            ]
                                                                                                                                                                                                                                            }, '3264-欣銓科技': {'持股數量': ['3151000', '3151000'
                                                                                                                                                                                                                                                                      ], '市值': ['192526100', '190005300'
                                                                                                                                                                                                                                                                                ], '佔淨值比例': ['2.343%', '2.277%'
                                                                                                                                                                                                                                                                                             ]
                                                                                                                                                                                                                                                             }, '8081-致新科技': {'持股數量': ['985000', '985000'
                                                                                                                                                                                                                                                                                       ], '市值': ['192075000', '194045000'
                                                                                                                                                                                                                                                                                                 ], '佔淨值比例': ['2.337%', '2.325%'
                                                                                                                                                                                                                                                                                                              ]
                                                                                                                                                                                                                                                                              }, '5483-中美矽晶': {'持股數量': ['1193000', '1193000'
                                                                                                                                                                                                                                                                                                        ], '市值': ['188494000', '189687000'
                                                                                                                                                                                                                                                                                                                  ], '佔淨值比例': ['2.294%', '2.273%'
                                                                                                                                                                                                                                                                                                                               ]
                                                                                                                                                                                                                                                                                               }, '3189-景碩科技': {'持股數量': ['1682000', '1682000'
                                                                                                                                                                                                                                                                                                                         ], '市值': ['188384000', '193430000'
                                                                                                                                                                                                                                                                                                                                   ], '佔淨值比例': ['2.293%', '2.318%'
                                                                                                                                                                                                                                                                                                                                                ]
                                                                                                                                                                                                                                                                                                                }, '3044-健鼎科技': {'持股數量': ['1533000', '1533000'
                                                                                                                                                                                                                                                                                                                                          ], '市值': ['185493000', '186259500'
                                                                                                                                                                                                                                                                                                                                                    ], '佔淨值比例': ['2.257%', '2.232%'
                                                                                                                                                                                                                                                                                                                                                                 ]
                                                                                                                                                                                                                                                                                                                                 }, '2337-旺宏電子': {'持股數量': ['5678000', '5678000'
                                                                                                                                                                                                                                                                                                                                                           ], '市值': ['183967200', '185670600'
                                                                                                                                                                                                                                                                                                                                                                     ], '佔淨值比例': ['2.239%', '2.225%'
                                                                                                                                                                                                                                                                                                                                                                                  ]
                                                                                                                                                                                                                                                                                                                                                  }, '4938-和碩聯合': {'持股數量': ['2453000', '2453000'
                                                                                                                                                                                                                                                                                                                                                                            ], '市值': ['183484400', '184220300'
                                                                                                                                                                                                                                                                                                                                                                                      ], '佔淨值比例': ['2.233%', '2.207%'
                                                                                                                                                                                                                                                                                                                                                                                                   ]
                                                                                                                                                                                                                                                                                                                                                                   }, '4958-臻鼎-KY': {'持股數量': ['1685000', '1685000'
                                                                                                                                                                                                                                                                                                                                                                                              ], '市值': ['177767500', '176082500'
                                                                                                                                                                                                                                                                                                                                                                                                        ], '佔淨值比例': ['2.163%', '2.110%'
                                                                                                                                                                                                                                                                                                                                                                                                                     ]
                                                                                                                                                                                                                                                                                                                                                                                     }, '4919-新唐科技': {'持股數量': ['1387000', '1387000'
                                                                                                                                                                                                                                                                                                                                                                                                               ], '市值': ['176149000', '177536000'
                                                                                                                                                                                                                                                                                                                                                                                                                         ], '佔淨值比例': ['2.144%', '2.127%'
                                                                                                                                                                                                                                                                                                                                                                                                                                      ]
                                                                                                                                                                                                                                                                                                                                                                                                      }, '2474-可成科技': {'持股數量': ['909000', '909000'
                                                                                                                                                                                                                                                                                                                                                                                                                                ], '市值': ['172710000', '163165500'
                                                                                                                                                                                                                                                                                                                                                                                                                                          ], '佔淨值比例': ['2.102%', '1.955%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                       ]
                                                                                                                                                                                                                                                                                                                                                                                                                       }, '6191-精成科技': {'持股數量': ['3572000', '3572000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                 ], '市值': ['167169600', '165026400'
                                                                                                                                                                                                                                                                                                                                                                                                                                                           ], '佔淨值比例': ['2.034%', '1.977%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ]
                                                                                                                                                                                                                                                                                                                                                                                                                                        }, '2385-群光電子': {'持股數量': ['1707000', '1707000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ], '市值': ['166091100', '166603200'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ], '佔淨值比例': ['2.021%', '1.996%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                         }, '6147-頎邦科技': {'持股數量': ['2635000', '2635000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ], '市值': ['166005000', '165478000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ], '佔淨值比例': ['2.020%', '1.983%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }, '5469-瀚宇博德': {'持股數量': ['3370000', '3370000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ], '市值': ['162434000', '162939500'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ], '佔淨值比例': ['1.977%', '1.952%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }, '2313-華通電腦': {'持股數量': ['3621000', '3621000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ], '市值': ['162401850', '162220800'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ], '佔淨值比例': ['1.976%', '1.944%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }, '8150-南茂科技': {'持股數量': ['4167000', '4167000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ], '市值': ['162304650', '151470450'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ], '佔淨值比例': ['1.975%', '1.815%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }, '6182-合晶科技': {'持股數量': ['3417000', '3417000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ], '市值': ['161282400', '160428150'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ], '佔淨值比例': ['1.963%', '1.922%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }, '5371-中強光電': {'持股數量': ['2192000', '2192000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ], '市值': ['160673600', '159577600'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ], '佔淨值比例': ['1.955%', '1.912%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }, '3596-智易科技': {'持股數量': ['1303000', '1303000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ], '市值': ['159617500', '158966000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ], '佔淨值比例': ['1.942%', '1.905%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }, '3014-聯陽半導': {'持股數量': ['1378000', '1378000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ], '市值': ['152958000', '153647000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ], '佔淨值比例': ['1.861%', '1.841%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }, '6239-力成科技': {'持股數量': ['1475000', '1475000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ], '市值': ['152662500', '154875000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ], '佔淨值比例': ['1.858%', '1.856%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }, '2347-聯強國際': {'持股數量': ['2574000', '2574000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ], '市值': ['152380800', '151093800'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ], '佔淨值比例': ['1.854%', '1.810%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }, '2301-光寶科技': {'持股數量': ['1498000', '1498000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ], '市值': ['149800000', '152796000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ], '佔淨值比例': ['1.823%', '1.831%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, '3702-大聯大控': {'持股數量': ['2689000', '2689000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ], '市值': ['147626100', '147357200'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ], '佔淨值比例': ['1.797%', '1.766%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }, '8358-金居開發': {'持股數量': ['2370000', '2370000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ], '市值': ['142200000', '142437000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ], '佔淨值比例': ['1.731%', '1.707%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }, '2352-佳世達科': {'持股數量': ['3097000', '3097000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ], '市值': ['139674700', '141842600'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ], '佔淨值比例': ['1.700%', '1.700%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }, '8299-群聯電子': {'持股數量': ['282000', '282000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ], '市值': ['119568000', '119427000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ], '佔淨值比例': ['1.455%', '1.431%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }, '3042-台灣晶技': {'持股數量': ['1198000', '1198000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ], '市值': ['111533800', '112132800'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ], '佔淨值比例': ['1.357%', '1.344%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }, '2379-瑞昱半導': {'持股數量': ['288000', '288000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ], '市值': ['111456000', '113184000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ], '佔淨值比例': ['1.356%', '1.356%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }, '3034-聯詠科技': {'持股數量': ['106000', '106000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ], '市值': ['48654000', '48336000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ], '佔淨值比例': ['0.592%', '0.579%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }, '2404-漢唐集成': {'持股數量': ['219000', '219000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ], '市值': ['48180000', '47742000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ], '佔淨值比例': ['0.586%', '0.572%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }, '6285-啟碁科技': {'持股數量': ['252000', '252000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ], '市值': ['23763600', '24318000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ], '佔淨值比例': ['0.289%', '0.291%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }, '3036-文曄科技': {'持股數量': ['236000', '236000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ], '市值': ['15906400', '15930000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ], '佔淨值比例': ['0.194%', '0.191%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }, '8213-志超科技': {'持股數量': ['206000', '206000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ], '市值': ['8075200', '8188500'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ], '佔淨值比例': ['0.098%', '0.098%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }, '3260-威剛科技': {'持股數量': ['91000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ], '市值': ['8026200', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ], '佔淨值比例': ['0.098%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }, '2377-微星科技': {'持股數量': ['46000', '46000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ], '市值': ['7935000', '8004000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ], '佔淨值比例': ['0.097%', '0.096%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }, '2324-仁寶電腦': {'持股數量': ['27000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ], '市值': ['784350', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ], '佔淨值比例': ['0.010%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }, '3033-威健實業': {'持股數量': ['24000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ], '市值': ['783600', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ], '佔淨值比例': ['0.010%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }, '6116-瀚宇彩晶': {'持股數量': ['61000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ], '市值': ['786900', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ], '佔淨值比例': ['0.010%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, '6257-矽格股份': {'持股數量': ['14000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ], '市值': ['770000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ], '佔淨值比例': ['0.009%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }, '6202-盛群半導': {'持股數量': ['11000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ], '市值': ['749100', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ], '佔淨值比例': ['0.009%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }, '2382-廣達電腦': {'持股數量': ['5000', '5000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ], '市值': ['720000', '732500'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ], '佔淨值比例': ['0.009%', '0.009%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }, '2458-義隆電子': {'持股數量': ['7000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ], '市值': ['707000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ], '佔淨值比例': ['0.009%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }, '6274-台燿科技': {'持股數量': ['10000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ], '市值': ['713000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ], '佔淨值比例': ['0.009%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }, '2376-技嘉科技': {'持股數量': ['3000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ], '市值': ['681000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ], '佔淨值比例': ['0.008%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }, '3515-華擎科技': {'持股數量': ['3000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ], '市值': ['627000', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ], '佔淨值比例': ['0.008%', None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }, '8050-廣積科技': {'持股數量': [None, '285000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ], '市值': [None, '24709500'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ], '佔淨值比例': [None, '0.296%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }, '6414-樺漢科技': {'持股數量': [None, '89000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ], '市值': [None, '24297000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ], '佔淨值比例': [None, '0.291%'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
             }

app = Flask(__name__)

app.secret_key = 'your_secret_key'  # 設置一個密鑰，用於啟用 flash 消息


@app.route('/')
def home():
    return render_template('index.html', message='Hello from Docker and Flask!')


@app.route('/scraper')
def scraper_index():
    return render_template('scraper.html')


@app.route('/crawl', methods=['POST'])
def crawl():
    etf_code = request.form.get('etf_code')
    start_date = request.form.get('start_date')
    end_date = request.form.get('end_date')
    data_type = request.form.get('data_type')
    company = request.form.get('company')

    print(start_date, end_date, etf_code, data_type, company)

    scraper = ETFScraper()
    if company == 'fhtrust':

        # if etf_data['ok'] and data_type == 'fund_asset':
        #     etf_data = scraper.scrape_fhtrust_data(
        #         etf_code, start_date, end_date, data_type)
        #     # 如果爬取成功，顯示結果
        #     return render_template('fund_asset_result.html', etf_data=etf_data, etf_code=etf_code)
        # elif etf_data['ok'] and data_type == 'holding_list':
        if data_type == 'holding_list':

            etf_data_test = test_data
            return render_template('fund_holding_list.html', etf_data=etf_data_test, etf_code=etf_code)

        else:
            # 如果爬取失敗，顯示錯誤消息並重新導向到爬蟲頁面
            # flash(etf_data['message'], 'error')
            return redirect('/scraper')


@app.route('/download_excel/<string:report_type>', methods=['POST'])
def download_excel(report_type):
    try:
        etf_data = request.json.get('etf_data')

        if report_type == '持股清單':
            # 如果要下載持股清單
            df = pd.DataFrame({
                '日期': etf_data['日期'],
                '持股數量': etf_data['持股數量'],
                '市值': etf_data['市值'],
                '佔淨值比例': etf_data['佔淨值比例'],
            })
        elif report_type == '基金總淨值':
            # 如果要下載基金總淨值
            df = pd.DataFrame({
                '日期': etf_data['日期'],
                '基金資產淨值': etf_data['基金資產淨值'],
                '基金在外流通單位數': etf_data['基金在外流通單位數'],
                '基金每單位淨值': etf_data['基金每單位淨值'],
            })
        else:
            return 'Invalid report type'

        # print(df)
        # '''
        #  日期           基金資產淨值      基金在外流通單位數 基金每單位淨值
        # 0  2023/12/01  106,994,957,274  5,802,639,000   18.44
        # 1  2023/12/04  107,799,380,136  5,803,639,000   18.57
        # '''

        excel_file_path = f"{report_type}.xlsx"
        df.to_excel(excel_file_path, index=False)

        # 發送檔案到客戶端
        response = send_file(excel_file_path, as_attachment=True)

        # 刪除伺服器本地的檔案
        os.remove(excel_file_path)

        return response

    except Exception as e:
        return jsonify({'ok': False, 'message': str(e)})


# @app.route('/download_excel')
# def download_excel():
#     # 創建一個簡單的 DataFrame，這裡只是示範，實際上你需要根據你的資料生成 DataFrame
#     start_date_str = request.args.get('start_date')
#     end_date_str = request.args.get('end_date')
#     etf_code = request.args.get('etf_code')
#     print(start_date_str,end_date_str,etf_code)

#     # 呼叫 scrape_data 函數並傳遞參數
#     data = scrape_data(etf_code, start_date_str, end_date_str)

#     df = pd.DataFrame(data)

#     # 將 DataFrame 寫入 Excel 檔案
#     excel_file_path = 'sample_data.xlsx'
#     df.to_excel(excel_file_path, index=False)

#     # 提供下載連結
#     return send_file(excel_file_path, as_attachment=True)

# @app.route('/download_excel')
# def download_excel():
#     # 創建一個簡單的 DataFrame，這裡只是示範，實際上你需要根據你的資料生成 DataFrame
#     data = {'Name': ['Alice', 'Bob', 'Charlie'],
#             'Age': [25, 30, 35]}
#     df = pd.DataFrame(data)

#     # 將 DataFrame 寫入 Excel 檔案
#     excel_file_path = 'sample_data.xlsx'
#     df.to_excel(excel_file_path, index=False)

#     # 提供下載連結
#     return send_file(excel_file_path, as_attachment=True)

@app.route('/download_specific_excel')
def download_specific_excel():
    # 取得起始、結束日期和 ETF 代號參數
    start_date_str = request.args.get('start_date')
    end_date_str = request.args.get('end_date')
    etf_code = request.args.get('etf_code')

    try:
        # 將字串轉換為日期，使用 pd.to_datetime，並指定格式
        start_date = pd.to_datetime(start_date_str, format='%Y-%m-%d')
        end_date = pd.to_datetime(end_date_str, format='%Y-%m-%d')

        # 在這裡根據你的邏輯生成特定日期範圍和 ETF 代號的 DataFrame
        date_range = pd.date_range(start=start_date, end=end_date)
        data = {
            'AAPL': [100] * len(date_range),  # 這裡可以換成對應 ETF 的實際資料
            'GOOGL': [1200] * len(date_range),
            'MSFT': [200] * len(date_range)
        }

        # 日期格式設定
        df = pd.DataFrame(data, index=date_range)

        # 將 DataFrame 轉置，讓 ETF 代號成為列標籤
        df.index = df.index.strftime('%Y-%m-%d')

        df_transposed = df.transpose()

        # 將 DataFrame 寫入 Excel 檔案，檔案名稱包含起始和結束日期以及 ETF 代號
        excel_file_path = f'{etf_code}_{start_date_str}_to_{end_date_str}_{etf_code}.xlsx'

        # 使用 ExcelWriter 並指定日期格式
        with pd.ExcelWriter(excel_file_path, engine='openpyxl', date_format='yyyy-mm-dd', datetime_format='yyyy-mm-dd') as writer:
            df_transposed.to_excel(writer, index_label='stock')

            # 取得 workbook 對象
            workbook = writer.book

            # 查看 sheets
            sheets = workbook.sheetnames
            print("Sheets:", sheets)

            # 選擇第一個 sheet
            worksheet = workbook[sheets[0]]

            # 從第一列開始檢查每一行的第一欄是否有值
            sheet_rowx = 1
            while worksheet.cell(row=sheet_rowx, column=1).value is not None:
                sheet_rowx += 1

            # 在找到的第一個空行中寫入特定的文字
            current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            worksheet.cell(row=sheet_rowx, column=1,
                           value=f'輸出時間{current_time}')

            # 合併指定的儲存格
            worksheet.merge_cells(
                start_row=sheet_rowx, start_column=1, end_row=sheet_rowx, end_column=10)

        # 發送檔案到客戶端
        response = send_file(excel_file_path, as_attachment=True)

        # 刪除伺服器本地的檔案
        os.remove(excel_file_path)

        return response

    except ValueError:
        return "Invalid date format. Please enter dates in the format YYYY-MM-DD."


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
